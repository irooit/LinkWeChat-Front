import{b as e,c as t}from"./groupMessage-f31c8fd2.js";import"./index-0bf429ac.js";import{g as s}from"./businessConver-2b86f97c.js";import{g as l}from"./group-e56f61ac.js";import{ai as a,aq as i,o as r,T as o,U as m,a as u,_ as n,Y as d,aa as p,V as c,c as h,K as g,a9 as f,Z as y,P as b,X as v,R as j,$ as T,bl as C,bj as S}from"./@vue-e400fd81.js";import{_}from"./quill-image-resize-module-c051113e.js";import{h as w}from"./moment-8163541f.js";import{B as k,a7 as G}from"../index-044285d2.js";import{A as V}from"./AddMaterial-51d9aa5c.js";import"./quill-c6b3d2fb.js";import"./@babel-efd68da6.js";import"./to-fast-properties-1160b370.js";import"./quill-delta-a1872f89.js";import"./fast-diff-d5a53119.js";import"./lodash.clonedeep-1b6eefdc.js";import"./lodash.isequal-e7d08617.js";import"./@vueup-7cf8cfdd.js";import"./js-cookie-8253c38e.js";/* empty css                      */import"./vue-router-f8d53be7.js";import"./element-plus-68ba2566.js";import"./lodash-es-d4f5f48c.js";import"./@element-plus-214e0f7b.js";import"./@popperjs-b78c3215.js";import"./@ctrl-91de2ec7.js";import"./dayjs-c17bc6b2.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-36fbce82.js";import"./pinia-1b56b17e.js";import"./vue-demi-71ba0ef2.js";import"./jsencrypt-43f479c1.js";import"./crypto-js-d6a67473.js";import"./ali-oss-912914b8.js";import"./axios-fb5f9e0e.js";import"./@vueuse-4025ce01.js";import"./path-browserify-289407ee.js";import"./nprogress-a39edb90.js";import"./clipboard-7a0da8dc.js";import"./PreviewInPhone-9ed75a0f.js";import"./scriptCenter-9e8c6ca2.js";import"./modleCenter-5112f339.js";import"./DragTable-97e90e96.js";import"./sortablejs-b0ad9b27.js";import"./MessageContentForm-5a22ed37.js";import"./staff-48996164.js";import"./PicTitContent-8b500b6d.js";import"./PosterAdd-51b39872.js";import"./index-618cff16.js";import"./tag-13936295.js";import"./fabric-8da0df30.js";import"./poster-241340a9.js";import"./liveCodeTable-73b404a8.js";import"./group-16414119.js";import"./pullNews-68e01d94.js";import"./TemplateLibrary-f59d0076.js";import"./welcome-6ff4c53e.js";const L={components:{SelectCustomerGroup:_({components:{},props:{visible:{type:Boolean,default:!1},title:{type:String,default:"选择客户群聊"},multiSelect:{type:Boolean,default:!1},selected:{type:Array,default:()=>[]}},data:()=>({loading:!0,query:{pageNum:1,pageSize:10,groupLeader:"",groupName:"",beginTime:"",endTime:""},list:[],total:0,selectedGroup:"",multiSelectedGroups:[]}),watch:{selected:{deep:!0,handler(e){this.setSelected()}},list:{deep:!0,handler(e){this.setSelected()}}},computed:{Pvisible:{get(){return this.visible},set(e){this.$emit("update:visible",e)}}},created(){this.getList()},mounted(){},methods:{getList(e){e&&(this.query.pageNum=e),this.loading=!0,l(this.query).then((({rows:e,total:t})=>{this.list=e,this.total=+t,this.loading=!1})).catch((()=>{this.loading=!1}))},submit(){this.Pvisible=!1,this.$emit("success",this.multiSelect?this.multiSelectedGroups:this.selectedGroup)},setSelected(){this.selected.length&&this.list.forEach((e=>{e.id==this.selected[0].id&&(this.selectedGroup=e)}))},handleSelectionChange(e){this.multiSelectedGroups=e}}},[["render",function(e,t,s,l,h,g){const f=a("el-input"),y=a("el-button"),b=a("el-pagination"),v=a("el-form-item"),j=a("el-form"),T=a("el-table-column"),C=a("el-radio"),S=a("el-table"),_=a("el-dialog"),w=i("hasPermi"),k=i("loading");return r(),o(_,{title:s.title,modelValue:g.Pvisible,"onUpdate:modelValue":t[6]||(t[6]=e=>g.Pvisible=e),width:"650px","append-to-body":"","close-on-click-modal":!1},{footer:m((()=>[u("div",null,[n(y,{onClick:t[5]||(t[5]=e=>g.Pvisible=!1)},{default:m((()=>[d("取 消")])),_:1}),n(y,{type:"primary",onClick:g.submit},{default:m((()=>[d("确 定")])),_:1},8,["onClick"])])])),default:m((()=>[u("div",null,[n(j,{ref:"form",model:h.query,"label-width":""},{default:m((()=>[n(v,{label:""},{default:m((()=>[n(f,{modelValue:h.query.groupName,"onUpdate:modelValue":t[0]||(t[0]=e=>h.query.groupName=e),class:"ml10 mr10",style:{width:"150px"},placeholder:"请输入群名",onKeyup:t[1]||(t[1]=p((e=>g.getList(1)),["enter"])),clearable:"",onClear:t[2]||(t[2]=e=>g.getList(1))},null,8,["modelValue"]),c(n(y,{icon:"el-icon-search",circle:"",onClick:t[3]||(t[3]=e=>g.getList(1))},null,512),[[w,["contacts:organization:query"]]]),n(b,{class:"fr",onCurrentChange:g.getList,"current-page":h.query.pageNum,"page-size":h.query.pageSize,layout:"prev, pager, next",total:h.total},null,8,["onCurrentChange","current-page","page-size","total"])])),_:1})])),_:1},8,["model"]),c((r(),o(S,{data:h.list,onSelectionChange:g.handleSelectionChange},{default:m((()=>[s.multiSelect?(r(),o(T,{key:0,type:"selection",width:"50",align:"center"})):(r(),o(T,{key:1,width:"30"},{default:m((e=>[n(C,{modelValue:h.selectedGroup,"onUpdate:modelValue":t[4]||(t[4]=e=>h.selectedGroup=e),label:e.row},{default:m((()=>[d("'")])),_:2},1032,["modelValue","label"])])),_:1})),n(T,{prop:"groupName",label:"群名",align:"center"}),n(T,{prop:"memberNum",label:"群人数",align:"center"}),n(T,{prop:"groupLeaderName",label:"群主",align:"center"}),n(T,{prop:"createTime",label:"创建时间",align:"center"})])),_:1},8,["data","onSelectionChange"])),[[k,h.loading]])])])),_:1},8,["title","modelValue"])}],["__scopeId","data-v-1008b895"]]),AddMaterial:V},props:{},data(){return{stageList:[],active:0,loading:!1,form:{chatType:1,isAll:0,gender:"",trackState:"",rangeTime:[],sendClientTagList:[],sendClientUserList:[],tag:[],department:[],staffId:[],isTask:0,sendTime:"",customerList:[]},userParty:[],rules:{isAll:[{required:!0,message:"请选择",trigger:"change"},{validator:this.validateClientGroup,trigger:"blur"}],isTask:[{validator:this.validateSettingTimeType,trigger:"blur"}]},statusOptions:Object.freeze([{label:"发送给客户",value:"0"},{label:"发送给客户群",value:"1"}]),activeName:"0",dialogVisibleSelectCustomer:!1,dialogVisibleSelectCustomerGroup:!1,selectCustomerGroupList:[],pickerOptions:{disabledDate(e){var t=new Date;return t.setFullYear(t.getFullYear()+2),t.setDate(t.getDate()-1),e.getTime()<Date.now()-864e5||e.getTime()>t.getTime()},selectableRange:k(new Date(w().format("YYYY-MM-DD HH:mm:ss")),"{hh}:{ii}:{ss}")+"- 23:59:59"},materialData:{templateInfo:"",materialMsgList:[]}}},watch:{"form.sendTime"(e){const t=(new Date).valueOf(),s=new Date(e).valueOf();this.pickerOptions.selectableRange=s>t?k(new Date(w().format("YYYY-MM-DD HH:mm:ss")),"00:00:00")+"- 23:59:59":k(new Date(w().format("YYYY-MM-DD HH:mm:ss")),"{hh}:{ii}:{ss}")+"- 23:59:00"}},computed:{isOnlyTag(){return this.form.tag[0]&&0==this.form.chatType},isSelectedText(){return this.userParty[0]||this.isOnlyTag},selectedText(){return`将发送消息给${this.userParty[0]?this.userParty[0].name+"等部门或成员的":""}${this.userParty[0]&&this.isOnlyTag?"，且":""}${this.isOnlyTag?"满足"+this.form.tag[0].name+"等标签的":""}${0==this.form.chatType?"客户":"客户群"}`}},created(){this.$store.setBusininessDesc("<div>每位客户/每个客户群每天可接收1条群发消息，可以是企业统一创建发送的，也可以是成员自己创建发送的；超过接收上限的客户/客户群将无法再收到群发消息。</div>"),this.$route.query.chatType&&(this.form.chatType=Number(this.$route.query.chatType)),this.getStage(),this.$route.query.id&&e(this.$route.query.id).then((({data:e={}})=>{var t,s,l,a,i,r,o,m,u,n,d;G(e,["id"]),this.form=Object.assign(e,this.$route.query),this.form.isTask=+this.form.isTask,this.form.isAll=this.form.isAll?0:1,this.form.weCustomersQuery=null==(t=e.weCustomersOrGroupQuery)?void 0:t.weCustomersQuery;let p=null==(i=null==(a=null==(l=null==(s=e.weCustomersOrGroupQuery)?void 0:s.weGroupQuery)?void 0:l.ownerNames)?void 0:a.split)?void 0:i.call(a,",");this.selectCustomerGroupList=(null==(d=null==(n=null==(u=null==(m=null==(o=null==(r=e.weCustomersOrGroupQuery)?void 0:r.weGroupQuery)?void 0:o.owners)?void 0:m.split)?void 0:u.call(m,","))?void 0:n.map)?void 0:d.call(n,((e,t)=>({userId:e,name:p[t]}))))||[],this.materialData={templateInfo:(null==e?void 0:e.content)||"",attachments:(null==e?void 0:e.weGroupMessageAttachmentsVo)||[]}}))},mounted(){},methods:{getStage(){s().then((e=>{this.stageList=e.data}))},parseTime(e,t){if(0===arguments.length)return null;const s=t||"{y}-{m}-{d} {h}:{i}:{s}";let l;"object"==typeof e?l=e:("string"==typeof e&&/^[0-9]+$/.test(e)&&(e=parseInt(e)),"number"==typeof e&&10===e.toString().length&&(e*=1e3),l=new Date(e));const a={y:l.getFullYear(),m:l.getMonth()+1,d:l.getDate(),h:l.getHours(),i:l.getMinutes(),s:l.getSeconds(),a:l.getDay()};return s.replace(/{([ymdhisa])+}/g,((e,t)=>{const s=a[t];return"a"===t?["日","一","二","三","四","五","六"][s]:s.toString().padStart(2,"0")}))},validateClientGroup(e,t,s){2==this.form.chatType&&1==this.form.isAll&&0==this.selectCustomerGroupList.length?s("请选择群主"):s()},validateSettingTimeType(e,t,s){1!=this.form.isTask||this.form.sendTime?s():s("请选择发送时间")},nextStep(){this.$refs.form.validate((e=>{e&&(1==this.form.chatType&&1==this.form.isAll?(this.$store.loading=!0,this.$refs.customerRangeForm.getCustomerList().then((e=>{(null==e?void 0:e.length)&&(this.form.senderList=e,this.active++)})).finally((()=>{this.$store.loading=!1}))):this.active++)}))},resetData(e){let t=[];return e&&e.length&&e.forEach((e=>{if("0"===e.msgType){let s={msgType:"image",picUrl:e.materialUrl};t.push(s)}else if("8"===e.msgType){let s={msgType:"link",title:e.materialName,linkUrl:e.materialUrl};t.push(s)}else if("9"===e.msgType){let s={msgType:"miniprogram",appId:e.digest,title:e.materialName,picUrl:e.coverUrl,linkUrl:e.materialUrl};t.push(s)}})),t},save(e){let s=e.attachments,l={content:e.templateInfo,attachmentsList:[{content:e.templateInfo,msgType:"text"}]};l.attachmentsList.push(...s);let a=Object.assign({},this.form,l);a=JSON.parse(JSON.stringify(a)),1===a.chatType?0===a.isAll&&(a.senderList=[]):1==a.isAll?a.senderList=this.selectCustomerGroupList.map((e=>({userId:e.userId}))):a.senderList=[],a.isAll=0==a.isAll,a.sendTime=1==a.isTask?k(new Date(a.sendTime)):"",delete a.department,delete a.rangeTime,delete a.sendClientUserList,delete a.sendClientTagList,delete a.tag,delete a.trackState,delete a.gender,delete a.staffId,this.$store.loading=!0,t(a).then((e=>{200==e.code?(this.$router.go(-1),this.msgSuccess("操作成功")):this.msgError(e.msg||"操作失败"),this.$store.loading=!1}))},onSelectCustomerGroup(){this.dialogVisibleSelectCustomerGroup=!0},submitSelectCustomerGroup(e){this.selectCustomerGroupList=e,this.$refs.form.clearValidate("isAll")}}},D=e=>(C("data-v-7de5b061"),e=e(),S(),e),A={class:"g-card"},q={key:0,class:"g-card"},U={class:"item-magin aic"},$=D((()=>u("div",{class:"item-name"},[u("span",{style:{color:"red"}},"*"),d(" 选择群主： ")],-1))),O={class:"item-magin"},M=D((()=>u("div",{class:"item-name"},"发送时间",-1))),N={class:"g-margin-t"};const P=_(L,[["render",function(e,t,s,l,i,p){const C=a("el-step"),S=a("el-steps"),_=a("el-radio"),w=a("el-radio-group"),k=a("el-form-item"),G=a("el-tag"),V=a("el-button"),L=a("CustomerRangeForm"),D=a("el-date-picker"),P=a("el-form"),I=a("AddMaterial"),Y=a("SelectUser");return r(),h("div",null,[u("div",A,[n(S,{active:i.active,"align-center":"","finish-status":"success"},{default:m((()=>[n(C,{title:"基础信息"}),n(C,{title:"群发内容"})])),_:1},8,["active"])]),0==i.active?(r(),h("div",q,[n(P,{style:{width:"60%",margin:"0 auto"},ref:"form",model:i.form,rules:i.rules,"label-width":"100px"},{default:m((()=>[n(k,{label:"群发类型",required:"",prop:"chatType"},{default:m((()=>[n(w,{modelValue:i.form.chatType,"onUpdate:modelValue":t[0]||(t[0]=e=>i.form.chatType=e)},{default:m((()=>[n(_,{label:1},{default:m((()=>[d("群发客户")])),_:1}),n(_,{label:2},{default:m((()=>[d("群发客户群")])),_:1})])),_:1},8,["modelValue"])])),_:1}),2==i.form.chatType?(r(),h(g,{key:0},[n(k,{label:"群发客户群",required:"",prop:"isAll"},{default:m((()=>[n(w,{modelValue:i.form.isAll,"onUpdate:modelValue":t[1]||(t[1]=e=>i.form.isAll=e)},{default:m((()=>[n(_,{label:0},{default:m((()=>[d("全部群")])),_:1}),n(_,{label:1},{default:m((()=>[d("部分群")])),_:1})])),_:1},8,["modelValue"])])),_:1}),1==i.form.isAll?(r(),o(k,{key:0},{default:m((()=>[u("div",null,[u("div",U,[$,(r(!0),h(g,null,f(i.selectCustomerGroupList,(e=>(r(),o(G,{key:e.userId},{default:m((()=>[d(y(e.name),1)])),_:2},1024)))),128)),n(V,{type:"primary",class:b(1==i.selectCustomerGroupList.length&&"ml10"),onClick:p.onSelectCustomerGroup},{default:m((()=>[d(" 选择群主 ")])),_:1},8,["class","onClick"])])])])),_:1})):v("",!0)],64)):v("",!0),1==i.form.chatType?(r(),h(g,{key:1},[n(k,{label:"群发客户",required:"",prop:"isAll"},{default:m((()=>[n(w,{modelValue:i.form.isAll,"onUpdate:modelValue":t[2]||(t[2]=e=>i.form.isAll=e)},{default:m((()=>[n(_,{label:0},{default:m((()=>[d("全部客户")])),_:1}),n(_,{label:1},{default:m((()=>[d("部分客户")])),_:1})])),_:1},8,["modelValue"])])),_:1}),1==i.form.isAll?(r(),o(k,{key:0},{default:m((()=>[n(L,{ref:"customerRangeForm",isTrans:"",data:i.form.weCustomersQuery,"onUpdate:data":t[3]||(t[3]=e=>i.form.weCustomersQuery=e)},null,8,["data"])])),_:1})):v("",!0)],64)):v("",!0),n(k,{label:"发送类型",required:"",prop:"isTask"},{default:m((()=>[n(w,{modelValue:i.form.isTask,"onUpdate:modelValue":t[4]||(t[4]=e=>i.form.isTask=e)},{default:m((()=>[n(_,{label:0},{default:m((()=>[d("立即发送")])),_:1}),n(_,{label:1},{default:m((()=>[d("定时发送")])),_:1})])),_:1},8,["modelValue"])])),_:1}),1==i.form.isTask?(r(),o(k,{key:2},{default:m((()=>[u("div",null,[u("div",O,[M,n(D,j({modelValue:i.form.sendTime,"onUpdate:modelValue":t[5]||(t[5]=e=>i.form.sendTime=e),type:"datetime",placeholder:"选择日期时间"},i.pickerOptions),null,16,["modelValue"])])])])),_:1})):v("",!0),n(k,{"label-width":"0"},{default:m((()=>[n(V,{type:"primary",onClick:p.nextStep},{default:m((()=>[d("下一步")])),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules"])])):v("",!0),c(u("div",N,[n(I,{showModle:!0,moduleType:4,otherType:2,onUpdate:t[6]||(t[6]=e=>i.active=0),onSubmit:p.save,baseData:i.materialData,isTransData:""},null,8,["onSubmit","baseData"])],512),[[T,1===i.active]]),n(Y,{visible:i.dialogVisibleSelectCustomerGroup,"onUpdate:visible":t[7]||(t[7]=e=>i.dialogVisibleSelectCustomerGroup=e),title:"选择添加人",destroyOnClose:"",defaultValues:i.selectCustomerGroupList,onSuccess:p.submitSelectCustomerGroup},null,8,["visible","defaultValues","onSuccess"])])}],["__scopeId","data-v-7de5b061"]]);export{P as default};
