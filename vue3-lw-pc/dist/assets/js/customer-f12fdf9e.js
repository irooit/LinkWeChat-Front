import{H as e,I as t,J as a,G as l,K as i,L as s,M as o,N as d,O as r}from"../index-044285d2.js";import{g as n}from"./tag-13936295.js";import{A as c}from"./AddTag-40a1def9.js";import{_ as u}from"./quill-image-resize-module-c051113e.js";import{ai as g,aq as p,o as h,T as m,U as y,a as f,_ as b,Y as T,V as k,c as S,K as v,a9 as q,Z as C,X as V,s as U,R as j,P as _,Q as w,$ as I}from"./@vue-e400fd81.js";import{g as D}from"./businessConver-2b86f97c.js";import"./js-cookie-8253c38e.js";/* empty css                      */import"./vue-router-f8d53be7.js";import"./element-plus-68ba2566.js";import"./lodash-es-d4f5f48c.js";import"./@element-plus-214e0f7b.js";import"./@popperjs-b78c3215.js";import"./@ctrl-91de2ec7.js";import"./dayjs-c17bc6b2.js";import"./@babel-efd68da6.js";import"./to-fast-properties-1160b370.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-36fbce82.js";import"./pinia-1b56b17e.js";import"./vue-demi-71ba0ef2.js";import"./jsencrypt-43f479c1.js";import"./crypto-js-d6a67473.js";import"./ali-oss-912914b8.js";import"./axios-fb5f9e0e.js";import"./@vueuse-4025ce01.js";import"./path-browserify-289407ee.js";import"./nprogress-a39edb90.js";import"./clipboard-7a0da8dc.js";import"./quill-c6b3d2fb.js";import"./quill-delta-a1872f89.js";import"./fast-diff-d5a53119.js";import"./lodash.clonedeep-1b6eefdc.js";import"./lodash.isequal-e7d08617.js";import"./@vueup-7cf8cfdd.js";const x={name:"delete-tag",components:{},props:{title:{type:String,default:"选择标签"},visible:{type:Boolean,default:!1},destroyOnClose:Boolean,type:{type:String,default:"1"},selected:{type:Array,default:()=>[]},initList:{type:Array,default:()=>{}}},data:()=>({loading:!1,list:[],listOneArray:[],selectedList:[],init:[]}),watch:{selected:{handler(e=[]){this.selectedList=[...e]},immediate:!0,deep:!0}},computed:{Pvisible:{get(){return this.visible},set(e){this.$emit("update:visible",e)}},checkedTagMap(){return new Set(this.selectedList.map((e=>e.tagId||"string"==typeof e&&e)))}},created(){this.getList()},mounted(){},methods:{setData(){this.list=[],this.initList.length?this.init.forEach(((e,t)=>{let a=!1;e.weTags.forEach((t=>{this.initList.includes(t.tagId)&&(t.show=!0,a||this.list.push(e),a=!0)}))})):this.list=[]},getList(){this.loading=!0,n({groupTagType:this.type}).then((({rows:e})=>{this.init=e,this.listOneArray=[],this.init.forEach((e=>{e.weTags.forEach((e=>{this.listOneArray.push({tagId:e.tagId,name:e.name})}))})),this.setData(),this.loading=!1}))},submit(){let e=[];if(this.selected.forEach((t=>{this.selectedList.includes(t)||e.push(t)})),e.length){let t=this.listOneArray.filter((t=>e.some((e=>e===t.tagId))));this.$emit("success",t),this.Pvisible=!1}else this.msgError("未操作任何标签！")},onSelectTag(e){const t=this.selectedList.findIndex((t=>t===e.tagId));t>-1?this.selectedList.splice(t,1):this.selectedList.push(e.tagId)},isSelected(e){return this.checkedTagMap.has(e.tagId)||this.checkedTagMap.has(e.name)}}},L={class:"label-group"},E={key:0,class:"label-group-item"},A={class:"label-group-item-title"},O={key:0,class:"label-group-item-body"};const N={key:0,class:"tag-place"},M={key:0,class:"tag-place"},R={class:"g-card"},B={class:"g-card-title mid-action"},$={class:"flex aic"},z={class:"g-color ml5 mr5"},J={class:"desc"},F=["onClick"],P={class:"ml10"},K={class:"blod"};const Y=u({name:"Customer",components:{AddTag:c,DeleteTag:u(x,[["render",function(e,t,a,l,i,s){const o=g("el-tag"),d=g("el-button"),r=g("el-dialog"),n=p("loading");return h(),m(r,{title:a.title,modelValue:s.Pvisible,"onUpdate:modelValue":t[1]||(t[1]=e=>s.Pvisible=e),"destroy-on-close":a.destroyOnClose},{footer:y((()=>[f("div",null,[b(d,{onClick:t[0]||(t[0]=e=>s.Pvisible=!1)},{default:y((()=>[T("取 消")])),_:1}),b(d,{type:"primary",onClick:s.submit},{default:y((()=>[T("确 定")])),_:1},8,["onClick"])])])),default:y((()=>[k((h(),S("div",null,[f("section",L,[(h(!0),S(v,null,q(i.list,((e,t)=>(h(),S(v,{key:t},[e?(h(),S("div",E,[f("div",A,C(e.groupName),1),e.weTags?(h(),S("div",O,[(h(!0),S(v,null,q(e.weTags,(e=>(h(),S(v,{key:e.tagId},[e.show?(h(),m(o,{key:0,type:s.isSelected(e)?"":"info",onClick:t=>s.onSelectTag(e)},{default:y((()=>[T(C(e.name),1)])),_:2},1032,["type","onClick"])):V("",!0)],64)))),128))])):V("",!0)])):V("",!0)],64)))),128))])])),[[n,i.loading]])])),_:1},8,["title","modelValue","destroy-on-close"])}],["__scopeId","data-v-d73049a2"]])},props:{},data:()=>({stageList:[],query:{pageNum:1,pageSize:10,name:"",userIds:"",tagIds:"",beginTime:"",endTime:"",customerType:"",trackState:"",addMethod:"",gender:"",noTagCheck:!1},queryTag:[],queryUser:[],dateRange:[],loading:!1,total:0,lastSyncTime:"",noRepeatCustomerTotal:0,form:{gourpName:"",weTags:[]},list:[],staffList:[],dialogVisible:!1,dialogVisibleSelectUser:!1,dialogVisibleAddTag:!1,dialogVisibleExtend:!1,extendStaff:"",currentEidt:"",selectedTag:[],tagDialogType:{title:"",type:""},dictCustomerType:Object.freeze({1:"微信客户",2:"企业客户"}),dictAddType:e,dictTrackState:t,multiObj:{state:"add",title:"批量打标签",showDialog:!1},multipleSelection:[],mulSelectedTag:[],deleteData:[],deleteDialog:!1}),watch:{},computed:{},created(){e().then((e=>this.dictAddType=e)),this.getStage(),this.getList(),this.getListTag(),this.$store.setBusininessDesc("\n        <div>用于查看当前企业所有的客户列表及详细信息，支持对客户进行打标签。</div>\n      ")},mounted(){},methods:{setValue(e){let t="";return this.stageList.forEach((a=>{a.stageVal==e&&(t=a.stageKey)})),t},openDeleteDialog(){let e=[];this.multipleSelection.forEach((t=>{t.tagIds&&e.push(...t.tagIds)})),this.deleteData=Array.from(new Set(e)),this.deleteDialog=!0},getDeleteData(e){let t=[];this.multipleSelection.forEach((a=>{let l={externalUserid:a.externalUserid,removeTag:e,userId:a.firstUserId};t.push(l)})),this.loading=!0,a({addOrRemove:!1,weMakeCustomerTagList:t}).then((e=>{this.getList(1),this.msgSuccess("批量删除标签成功"),this.deleteData=[],this.deleteDialog=!1,this.loading=!1})).catch((()=>{this.loading=!1}))},getMultiOperation(e){let t=[];this.multipleSelection.forEach((a=>{let l={externalUserid:a.externalUserid,addTag:e,userId:a.firstUserId};t.push(l)})),this.loading=!0,a({addOrRemove:"add"===this.multiObj.state,weMakeCustomerTagList:t}).then((e=>{this.getList(1),this.msgSuccess("批量设置标签成功"),this.multiObj.showDialog=!1,this.multipleSelection=[],this.loading=!1})).catch((()=>{this.loading=!1}))},getStage(){D().then((e=>{this.stageList=e.data}))},getList(e){this.dateRange?(this.query.beginTime=this.dateRange[0],this.query.endTime=this.dateRange[1]):(this.query.beginTime="",this.query.endTime=""),e&&(this.query.pageNum=e),this.query.tagIds=this.queryTag.map((e=>e.tagId))+"",this.query.userIds=this.queryUser.map((e=>e.userId))+"",this.loading=!0,l(this.query).then((({rows:e,total:t,lastSyncTime:a,noRepeatCustomerTotal:l})=>{e.forEach((e=>{e.tagIds&&e.tagNames&&(e.tagIds=e.tagIds.split(","),e.tagNames=e.tagNames.split(","),e.tags=[],e.tagIds.forEach(((t,a)=>{e.tags.push({tagId:t,tagName:e.tagNames[a]})})))})),this.list=e,this.total=+t,this.lastSyncTime=a,this.noRepeatCustomerTotal=+l,this.loading=!1,this.multipleSelection=[]})).catch((()=>{this.loading=!1}))},getListTag(e){n().then((({rows:t})=>{this.listTagOneArray=[],t.forEach((e=>{e.weTags.forEach((e=>{this.listTagOneArray.push(e)}))})),e&&(this.$refs.selectTag.getList(),this.form={gourpName:"",weTags:[]})}))},showTagDialog(){this.query.noTagCheck=!1,this.selectedTag=this.queryTag,this.tagDialogType={title:"选择标签",type:"query"},this.dialogVisible=!0},makeTag(e){this.currentEidt=e,this.selectedTag=[];let t=[],a=[];e.tags&&e.tags.forEach((e=>{if(this.selectedTag.some((t=>t.tagId===e.tagId)))return void a.push(e.tagName);let l=this.listTagOneArray.find((t=>t.tagId===e.tagId));l?this.selectedTag.push(l):t.push(e.tagName)})),t.length>0&&this.$notify({message:U("div",{style:"color: red;word-break:break-all"},"已有标签 [ "+t+" ] 不在标签库中，已被删除或存在异常"),type:"warning",customClass:"mzindex"}),this.tagDialogType={title:"标签设置"+(a.length?"（重复的标签已去重显示）":"")},this.dialogVisible=!0},sync(){i().then((()=>{this.getList(1),this.msgSuccess("后台开始同步数据，请稍后关注进度")})).catch((e=>{}))},selectedUser(e){this.queryUser=e},submitSelectTag(e){if("query"===this.tagDialogType.type)this.queryTag=e,this.dialogVisible=!1;else{let t=[];this.selectedTag.forEach((a=>{-1==e.findIndex((e=>e.tagId==a.tagId))&&t.push(a)}));let a={externalUserid:this.currentEidt.externalUserid,removeTag:t,addTag:e,userId:this.currentEidt.firstUserId};this.loading=!0,s(a).then((()=>{this.msgSuccess("操作成功"),this.dialogVisible=!1,this.getList(),this.loading=!1})).catch((()=>{this.loading=!1}))}},resetForm(e){this.dateRange=[],this.queryTag=[],this.queryUser=[],this.query.noTagCheck=!1,this.$refs.queryForm.resetFields(),this.getList(1)},handleSelectionChange(e){this.multipleSelection=e},handleSelection(e,t){this.$nextTick((()=>{this.$refs.table.clearSelection(),this.$refs.table.toggleRowSelection(t)}))},goRoute(e){let{externalUserid:t,firstUserId:a}=e;this.$router.push({name:window.lwConfig.CUSTOMER_DETAIL_ROUTE_NAME,query:{externalUserid:t,userId:a}})},async transfer(e){await this.$refs.SelectStaffForm.validate();let t={handoverUserId:this.currentEidt.firstUserId,takeoverUserId:this.extendStaff,externalUserid:this.currentEidt.externalUserid};o(t).then((e=>{this.msgSuccess("操作成功"),this.dialogVisibleExtend=!1,this.getList()}))},setData(e){this.queryTag=[],this.query.tagIds=""},exportData(){this.$exportData(d.bind(null,this.query),"导出客户.xlsx")},setBlackList(e){this.$confirm(1==e.isJoinBlacklist?"是否确认拉黑，拉黑后客户无法收到群发消息":"是否确认该操作","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>(this.loading=!0,r({isJoinBlacklist:1==e.isJoinBlacklist?0:1,customerIds:e.id})))).then((e=>{this.msgSuccess("操作成功"),this.getList(),this.loading=!1})).catch((function(){}))}}},[["render",function(e,t,a,l,i,s){const o=g("el-input"),d=g("el-form-item"),r=g("el-option"),n=g("el-select"),c=g("el-tag"),u=g("el-date-picker"),U=g("el-checkbox"),D=g("el-button"),x=g("el-form"),L=g("ButtonSync"),E=g("el-table-column"),A=g("el-image"),O=g("el-icon-Avatar"),Y=g("TagEllipsis"),G=g("el-table"),H=g("pagination"),Q=g("SelectTag"),X=g("SelectUser"),Z=g("AddTag"),W=g("SelectStaffForm"),ee=g("el-dialog"),te=g("DeleteTag"),ae=p("loading");return k((h(),S("div",null,[b(x,{ref:"queryForm",inline:!0,model:i.query,"label-width":"70px",class:"top-search"},{default:y((()=>[b(d,{label:"客户名称",prop:"name"},{default:y((()=>[b(o,{modelValue:i.query.name,"onUpdate:modelValue":t[0]||(t[0]=e=>i.query.name=e),placeholder:"请输入"},null,8,["modelValue"])])),_:1}),b(d,{label:"客户类型",prop:"customerType"},{default:y((()=>[b(n,{"popper-append-to-body":!1,modelValue:i.query.customerType,"onUpdate:modelValue":t[1]||(t[1]=e=>i.query.customerType=e),placeholder:"请选择"},{default:y((()=>[(h(!0),S(v,null,q(i.dictCustomerType,((e,t)=>(h(),m(r,{key:t,label:e,value:t},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),b(d,{label:"跟进员工",prop:"customerType"},{default:y((()=>[f("div",{class:"tag-input",onClick:t[2]||(t[2]=e=>i.dialogVisibleSelectUser=!0)},[i.queryUser.length?(h(!0),S(v,{key:1},q(i.queryUser,((e,t)=>(h(),m(c,{key:t},{default:y((()=>[T(C(e.name),1)])),_:2},1024)))),128)):(h(),S("span",N,"请选择"))])])),_:1}),b(d,{label:"商机阶段",prop:"trackState"},{default:y((()=>[b(n,{"popper-append-to-body":!1,modelValue:i.query.trackState,"onUpdate:modelValue":t[3]||(t[3]=e=>i.query.trackState=e),placeholder:"请选择"},{default:y((()=>[(h(!0),S(v,null,q(i.stageList,((e,t)=>(h(),m(r,{key:t,label:e.stageKey,value:e.stageVal},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),b(d,{label:"添加方式",prop:"addMethod"},{default:y((()=>[b(n,{"popper-append-to-body":!1,modelValue:i.query.addMethod,"onUpdate:modelValue":t[4]||(t[4]=e=>i.query.addMethod=e),placeholder:"请选择"},{default:y((()=>[(h(!0),S(v,null,q(i.dictAddType,((e,t)=>(h(),m(r,{key:t,label:e,value:t},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),b(d,{label:"添加日期"},{default:y((()=>[b(u,j({modelValue:i.dateRange,"onUpdate:modelValue":t[5]||(t[5]=e=>i.dateRange=e),"value-format":"YYYY-MM-DD",type:"daterange"},e.pickerOptions,{"range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",align:"right"}),null,16,["modelValue"])])),_:1}),b(d,{label:"客户标签",prop:"customerType"},{default:y((()=>[f("div",{class:"tag-input",onClick:t[6]||(t[6]=(...e)=>s.showTagDialog&&s.showTagDialog(...e))},[i.queryTag.length?(h(!0),S(v,{key:1},q(i.queryTag,((e,t)=>(h(),m(c,{key:t},{default:y((()=>[T(C(e.name),1)])),_:2},1024)))),128)):(h(),S("span",M,"请选择"))])])),_:1}),b(d,null,{default:y((()=>[b(U,{modelValue:i.query.noTagCheck,"onUpdate:modelValue":t[7]||(t[7]=e=>i.query.noTagCheck=e),onChange:s.setData},{default:y((()=>[T("无标签客户")])),_:1},8,["modelValue","onChange"]),b(U,{modelValue:i.query.isJoinBlacklist,"onUpdate:modelValue":t[8]||(t[8]=e=>i.query.isJoinBlacklist=e),"true-label":"0","false-label":"1"},{default:y((()=>[T("黑名单客户")])),_:1},8,["modelValue"])])),_:1}),b(d,{label:""},{default:y((()=>[b(D,{type:"primary",onClick:t[9]||(t[9]=e=>s.getList(1))},{default:y((()=>[T("查询")])),_:1}),b(D,{onClick:t[10]||(t[10]=e=>s.resetForm())},{default:y((()=>[T("重置")])),_:1})])),_:1})])),_:1},8,["model"]),f("div",R,[f("div",B,[f("div",$,[T(" 共 "),f("span",z,C(i.noRepeatCustomerTotal),1),T(" 位客户（去重） "),b(D,{type:"primary",onClick:s.exportData},{default:y((()=>[T("导出客户")])),_:1},8,["onClick"])]),f("div",null,[f("span",J,"最近同步："+C(i.lastSyncTime),1),b(L,{lastSyncTime:i.lastSyncTime,onClick:s.sync},{default:y((()=>[T("同步客户")])),_:1},8,["lastSyncTime","onClick"]),b(D,{class:"ml10",type:"primary",disabled:!i.multipleSelection.length,onClick:t[11]||(t[11]=e=>i.multiObj.showDialog=!0)},{default:y((()=>[T(" 批量打标签 ")])),_:1},8,["disabled"]),b(D,{type:"primary",disabled:!i.multipleSelection.length,onClick:t[12]||(t[12]=e=>s.openDeleteDialog())},{default:y((()=>[T(" 批量删标签 ")])),_:1},8,["disabled"])])]),b(G,{ref:"table",data:i.list,"tooltip-effect":"dark","highlight-current-row":"",onSelectionChange:s.handleSelectionChange},{default:y((()=>[b(E,{type:"selection",align:"center",width:"55"}),b(E,{label:"客户",prop:"customerName","header-align":"center",align:"",width:"180"},{default:y((({row:e})=>[f("div",{class:"cp flex aic",onClick:t=>s.goRoute(e)},[b(A,{class:"avatar",src:e.avatar,fit:"fill"},null,8,["src"]),f("div",P,[f("p",K,C(e.customerName),1),b(O,{class:_(["el-icon-Avatar",{1:"man",2:"woman"}[e.gender]])},null,8,["class"]),f("span",{style:w({color:1===e.customerType?"#4bde03":"#f9a90b"})},C({1:"@微信",2:"@企业微信"}[e.customerType]),5)])],8,F)])),_:1}),b(E,{prop:"tagNames",label:"客户标签",align:"center",width:"220"},{default:y((({row:e})=>[b(Y,{list:e.tagNames,emptyText:"无标签"},null,8,["list"])])),_:1}),b(E,{prop:"userName",label:"跟进员工",align:"center"}),b(E,{prop:"trackState",label:"商机阶段",align:"center"},{default:y((({row:e})=>[e.trackState?(h(),m(c,{key:0},{default:y((()=>[T(C(s.setValue(e.trackState)),1)])),_:2},1024)):V("",!0)])),_:1}),b(E,{prop:"addMethod",label:"添加方式",align:"center"},{default:y((({row:e})=>[T(C(i.dictAddType[e.addMethod+""]),1)])),_:1}),b(E,{prop:"firstAddTime",label:"添加时间",align:"center"}),b(E,{label:"操作",width:"220",align:"center",fixed:"right"},{default:y((({row:e,$index:t})=>[b(D,{text:"",onClick:t=>s.goRoute(e)},{default:y((()=>[T("查看")])),_:2},1032,["onClick"]),1==e.isJoinBlacklist?(h(),S(v,{key:0},[b(D,{text:"",onClick:t=>s.makeTag(e)},{default:y((()=>[T("标签管理")])),_:2},1032,["onClick"]),b(D,{text:"",disabled:e.isTransfer,onClick:t=>{i.dialogVisibleExtend=!0,i.currentEidt=e}},{default:y((()=>[T(" 在职继承 ")])),_:2},1032,["disabled","onClick"])],64)):V("",!0),b(D,{text:"",onClick:t=>s.setBlackList(e)},{default:y((()=>[T(C(1==e.isJoinBlacklist?"拉黑":"移出黑名单"),1)])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data","onSelectionChange"]),k(b(H,{total:i.total,page:i.query.pageNum,"onUpdate:page":t[13]||(t[13]=e=>i.query.pageNum=e),limit:i.query.pageSize,"onUpdate:limit":t[14]||(t[14]=e=>i.query.pageSize=e),onPagination:t[15]||(t[15]=e=>s.getList())},null,8,["total","page","limit"]),[[I,i.total>0]])]),b(Q,{ref:"selectTag",visible:i.dialogVisible,"onUpdate:visible":t[16]||(t[16]=e=>i.dialogVisible=e),title:i.tagDialogType.title,selected:i.selectedTag,onSuccess:s.submitSelectTag},null,8,["visible","title","selected","onSuccess"]),b(X,{visible:i.dialogVisibleSelectUser,"onUpdate:visible":t[17]||(t[17]=e=>i.dialogVisibleSelectUser=e),defaultValues:i.queryUser,title:"选择员工",onSuccess:s.selectedUser},null,8,["visible","defaultValues","onSuccess"]),b(Z,{visible:i.dialogVisibleAddTag,"onUpdate:visible":t[18]||(t[18]=e=>i.dialogVisibleAddTag=e),form:i.form,onSuccess:t[19]||(t[19]=e=>s.getListTag(!0))},null,8,["visible","form"]),b(ee,{title:"选择员工",modelValue:i.dialogVisibleExtend,"onUpdate:modelValue":t[22]||(t[22]=e=>i.dialogVisibleExtend=e),"close-on-click-modal":!1},{footer:y((()=>[f("div",null,[b(D,{onClick:t[21]||(t[21]=e=>i.dialogVisibleExtend=!1)},{default:y((()=>[T("取 消")])),_:1}),b(D,{type:"primary",onClick:s.transfer},{default:y((()=>[T("确 定")])),_:1},8,["onClick"])])])),default:y((()=>[b(W,{ref:"SelectStaffForm",selected:i.extendStaff,"onUpdate:selected":t[20]||(t[20]=e=>i.extendStaff=e)},null,8,["selected"])])),_:1},8,["modelValue"]),i.multiObj.showDialog?(h(),m(Q,{key:0,ref:"multiTag",selected:i.mulSelectedTag,visible:i.multiObj.showDialog,"onUpdate:visible":t[23]||(t[23]=e=>i.multiObj.showDialog=e),title:i.multiObj.title,onSuccess:s.getMultiOperation},null,8,["selected","visible","title","onSuccess"])):V("",!0),i.deleteDialog?(h(),m(te,{key:1,ref:"deleteTag",visible:i.deleteDialog,"onUpdate:visible":t[24]||(t[24]=e=>i.deleteDialog=e),initList:i.deleteData,selected:i.deleteData,onSuccess:s.getDeleteData},null,8,["visible","initList","selected","onSuccess"])):V("",!0)])),[[ae,i.loading]])}],["__scopeId","data-v-16b32103"]]);export{Y as default};
