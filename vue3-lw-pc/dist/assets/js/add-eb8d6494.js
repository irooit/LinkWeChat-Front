import{e,a as i,d as t}from"./api-49257dfd.js";import{_ as l}from"./quill-image-resize-module-c051113e.js";import{ai as o,o as s,c as r,a,_ as n,U as m,Y as u,K as d,a9 as c,T as p,X as f,Z as h,bl as g,bj as b}from"./@vue-e400fd81.js";import"../index-044285d2.js";import"./js-cookie-8253c38e.js";/* empty css                      */import"./vue-router-f8d53be7.js";import"./element-plus-68ba2566.js";import"./lodash-es-d4f5f48c.js";import"./@element-plus-214e0f7b.js";import"./@popperjs-b78c3215.js";import"./@ctrl-91de2ec7.js";import"./dayjs-c17bc6b2.js";import"./@babel-efd68da6.js";import"./to-fast-properties-1160b370.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-36fbce82.js";import"./pinia-1b56b17e.js";import"./vue-demi-71ba0ef2.js";import"./jsencrypt-43f479c1.js";import"./crypto-js-d6a67473.js";import"./ali-oss-912914b8.js";import"./axios-fb5f9e0e.js";import"./@vueuse-4025ce01.js";import"./path-browserify-289407ee.js";import"./nprogress-a39edb90.js";import"./clipboard-7a0da8dc.js";import"./quill-c6b3d2fb.js";import"./quill-delta-a1872f89.js";import"./fast-diff-d5a53119.js";import"./lodash.clonedeep-1b6eefdc.js";import"./lodash.isequal-e7d08617.js";import"./@vueup-7cf8cfdd.js";const y={name:"quality-add",data:()=>({loading:!1,dialogVisible:!1,singleSelect:[],singleSelectVisible:!1,orderIndex:null,form:{name:"",chatType:1,timeOut:10,manageUserInfo:[],qiRuleScope:[{beginTime:"",endTime:"",weQiRuleUserList:[],workCycle:[]}]},rules:{name:[{required:!0,message:"请输入质检规则名称",trigger:"blur"}],timeOut:[{required:!0,message:"请输入超时时间标准",trigger:"blur"},{pattern:/^[1-9][0-9]*$/,message:"超时时间标准必须为正整数",trigger:"blur"}],manageUserInfo:[{required:!0,message:"请选择质检督导",trigger:"blur"}]},timeConflict:!1}),methods:{getSingleUser(e){this.form.qiRuleScope[this.orderIndex].weQiRuleUserList=e},onSelectSingleUser(e){this.orderIndex=e,this.singleSelect=this.form.qiRuleScope[e].weQiRuleUserList,this.singleSelectVisible=!0},async checkData(){let e=!0;return await this.$refs.form.validate((i=>{if(i){let i=!0,t=!0,l=!0;this.form.qiRuleScope.forEach((e=>{e.weQiRuleUserList.length||(i=!1),e.workCycle.length||(t=!1),e.beginTime&&e.endTime||(l=!1)})),i?t?l?this.timeConflict&&(e=!1,this.msgError("排班存在冲突！")):(e=!1,this.msgError("请选择排班每项的在线时间！")):(e=!1,this.msgError("排班每项工作周期至少勾选一项！")):(e=!1,this.msgError("排班每项至少选择一名员工！"))}else e=!1})),e},async submit(){if(await this.checkData()){this.loading=!0;let t={name:this.form.name,chatType:this.form.chatType,timeOut:this.form.timeOut,manageUser:this.form.manageUserInfo.map((e=>e.userId)).join(",")},l=[];this.form.qiRuleScope.forEach((e=>{let i={beginTime:e.beginTime,endTime:e.endTime,workCycle:e.workCycle,userIds:e.weQiRuleUserList.map((e=>e.userId))};l.push(i)})),t.qiUserInfos=l,(this.form.id?e(this.$route.query.id,t):i(t)).then((e=>{200==e.code&&(this.msgSuccess("操作成功"),this.loading=!1,this.$router.back())}))}},checkStartEnd(e,i){this.timeConflict=!1,this.operationIndex=i,this.form.qiRuleScope[this.operationIndex].workCycle.length&&(this.form.qiRuleScope[this.operationIndex].beginTime||this.form.qiRuleScope[this.operationIndex].endTime)&&this.someTimeConflict()},someTimeConflict(){let e=[],i=[],t=this.form.qiRuleScope[this.operationIndex].weQiRuleUserList.map((e=>({userId:e.userId,name:e.userName})));this.form.qiRuleScope.forEach(((e,t)=>{e.weQiRuleUserList.map(((e,l)=>{t!=this.operationIndex&&i.push({userId:e.userId,name:e.userName,index:t,week:[],goto1:!0,goto2:!0})}))})),t.map((t=>{i.map((i=>{t.userId===i.userId&&e.push(i)}))}));let l=this.form.qiRuleScope[this.operationIndex].workCycle;e.forEach((e=>{const i=this.form.qiRuleScope[e.index].workCycle;for(var t=0;t<i.length;t++)-1!=l.indexOf(i[t])&&e.week.push(i[t])})),e.forEach((e=>{if(e.week.length){let i=this.form.qiRuleScope[e.index].beginTime,t=this.form.qiRuleScope[e.index].endTime;i&&t&&(this.form.qiRuleScope[this.operationIndex].beginTime&&(e.goto1=this.checkAuditTime(i,t,this.form.qiRuleScope[this.operationIndex].beginTime)),this.form.qiRuleScope[this.operationIndex].endTime&&(e.goto2=this.checkAuditTime(i,t,this.form.qiRuleScope[this.operationIndex].endTime)))}}));let o="";e.forEach((e=>{if(!e.goto1||!e.goto2){let i=e.week.map((e=>7===e?"日":e));o+="员工"+e.name+"在周"+i.join("、")+"时间存在冲突;"}})),o?(this.timeConflict=!0,this.msgError(o)):this.timeConflict=!1},checkAuditTime(e,i,t){let l=e.split(":");if(2!=l.length)return!1;let o=i.split(":");if(2!=o.length)return!1;let s=t.split(":");if(2!=s.length)return!1;let r=new Date,a=new Date,n=new Date;return r.setHours(l[0]),r.setMinutes(l[1]),a.setHours(o[0]),a.setMinutes(o[1]),n.setHours(s[0]),n.setMinutes(s[1]),!(n.getTime()-r.getTime()>=0&&n.getTime()-a.getTime()<=0)},getSelectUser(e){this.form.manageUserInfo=e},onAddCircle(){this.form.qiRuleScope.push({beginTime:"",endTime:"",weQiRuleUserList:[],workCycle:[]})},onRemoveRoster(e){this.form.qiRuleScope.splice(e,1)}},created(){this.$route.query.id&&t(this.$route.query.id).then((e=>{this.form=e.data,this.form.qiRuleScope.forEach((e=>{e.workCycle=e.workCycle.split(","),e.weQiRuleUserList.forEach((e=>{e.name=e.userName}))})),this.form.manageUserInfo.forEach((e=>{e.name=e.userName}))}))}},k={class:"g-card"},S=(e=>(g("data-v-abb5c835"),e=e(),b(),e))((()=>a("div",{class:"sub-des"},[a("span",null,"可根据不同成员的上班时间灵活调整配置")],-1))),w={style:{display:"flex","justify-content":"flex-end"}},j={class:"mt20"},U={key:0},T={class:"g-footer-sticky"};const q=l(y,[["render",function(e,i,t,l,g,b){const y=o("el-input"),q=o("el-form-item"),x=o("el-button"),R=o("el-tag"),C=o("el-checkbox"),I=o("el-checkbox-group"),_=o("el-time-select"),V=o("el-card"),v=o("el-radio"),E=o("el-radio-group"),L=o("el-form"),Q=o("SelectUser");return s(),r("div",null,[a("div",k,[n(L,{ref:"form",rules:g.rules,model:g.form,"label-position":"right","label-width":"140px"},{default:m((()=>[n(q,{label:"质检规则名称:",prop:"name"},{default:m((()=>[n(y,{modelValue:g.form.name,"onUpdate:modelValue":i[0]||(i[0]=e=>g.form.name=e),maxlength:"20","show-word-limit":"",clearable:""},null,8,["modelValue"])])),_:1}),n(q,{label:"超时时间标准:",prop:"timeOut"},{default:m((()=>[n(y,{modelValue:g.form.timeOut,"onUpdate:modelValue":i[1]||(i[1]=e=>g.form.timeOut=e),style:{width:"120px"},placeholder:"请输入"},null,8,["modelValue"]),u(" 分钟 ")])),_:1}),n(q,{label:"质检时间范围:",required:"",prop:"qiRuleScope",style:{width:"60%"}},{default:m((()=>[S,(s(!0),r(d,null,c(g.form.qiRuleScope,((e,i)=>(s(),p(V,{key:e.id,class:"box-card roster-card"},{default:m((()=>[a("div",w,[1!==g.form.qiRuleScope.length?(s(),p(x,{key:0,text:"",icon:"el-icon-delete",onClick:e=>b.onRemoveRoster(i)},{default:m((()=>[u(" 删除 ")])),_:2},1032,["onClick"])):f("",!0)]),n(q,{"label-width":"100px",label:"排班员工:"},{default:m((()=>[(s(!0),r(d,null,c(e.weQiRuleUserList,((e,i)=>(s(),p(R,{key:i},{default:m((()=>[u(h(e.userName),1)])),_:2},1024)))),128)),n(x,{icon:"el-icon-plus",style:{"margin-left":"10px"},type:"primary",onClick:e=>b.onSelectSingleUser(i)},{default:m((()=>[u(h(e.weQiRuleUserList.length?"修改":"选择")+"员工 ",1)])),_:2},1032,["onClick"])])),_:2},1024),n(q,{"label-width":"100px",label:"工作周期:"},{default:m((()=>[n(I,{modelValue:e.workCycle,"onUpdate:modelValue":i=>e.workCycle=i,onChange:e=>b.checkStartEnd(e,i)},{default:m((()=>[n(C,{label:"1"},{default:m((()=>[u("周一")])),_:1}),n(C,{label:"2"},{default:m((()=>[u("周二")])),_:1}),n(C,{label:"3"},{default:m((()=>[u("周三")])),_:1}),n(C,{label:"4"},{default:m((()=>[u("周四")])),_:1}),n(C,{label:"5"},{default:m((()=>[u("周五")])),_:1}),n(C,{label:"6"},{default:m((()=>[u("周六")])),_:1}),n(C,{label:"7"},{default:m((()=>[u("周日")])),_:1})])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])])),_:2},1024),n(q,{"label-width":"100px",label:"在线时间:"},{default:m((()=>[n(_,{style:{width:"130px"},modelValue:e.beginTime,"onUpdate:modelValue":i=>e.beginTime=i,start:"00:00",end:"23:59",step:"00:30","max-time":e.endTime,onChange:e=>b.checkStartEnd(e,i),placeholder:"任意时间点"},null,8,["modelValue","onUpdate:modelValue","max-time","onChange"]),u(" -- "),n(_,{style:{width:"130px"},start:"00:00",end:"23:59",step:"00:30","min-time":e.beginTime,onChange:e=>b.checkStartEnd(e,i),modelValue:e.endTime,"onUpdate:modelValue":i=>e.endTime=i,placeholder:"任意时间点"},null,8,["min-time","onChange","modelValue","onUpdate:modelValue"])])),_:2},1024)])),_:2},1024)))),128)),a("div",j,[n(x,{type:"primary",icon:"el-icon-plus",onClick:b.onAddCircle},{default:m((()=>[u("新增时间")])),_:1},8,["onClick"])])])),_:1}),n(q,{label:"质检会话类型",required:"",prop:"chatType"},{default:m((()=>[n(E,{modelValue:g.form.chatType,"onUpdate:modelValue":i[2]||(i[2]=e=>g.form.chatType=e)},{default:m((()=>[n(v,{label:1},{default:m((()=>[u("全部")])),_:1}),n(v,{label:2},{default:m((()=>[u("客户会话")])),_:1}),n(v,{label:3},{default:m((()=>[u("客群会话")])),_:1})])),_:1},8,["modelValue"])])),_:1}),n(q,{label:"质检督导:",prop:"manageUserInfo"},{default:m((()=>[g.form.manageUserInfo.length>0?(s(),r("div",U,[(s(!0),r(d,null,c(g.form.manageUserInfo,((e,i)=>(s(),p(R,{key:i},{default:m((()=>[u(h(e.userName),1)])),_:2},1024)))),128))])):f("",!0),n(x,{icon:"el-icon-plus",type:"primary",onClick:i[3]||(i[3]=e=>g.dialogVisible=!0)},{default:m((()=>[u(h(g.form.manageUserInfo.length?"修改":"选择")+"成员 ",1)])),_:1})])),_:1})])),_:1},8,["rules","model"])]),a("div",T,[n(x,{onClick:i[4]||(i[4]=i=>e.$router.back())},{default:m((()=>[u("取消")])),_:1}),n(x,{type:"primary",onClick:b.submit},{default:m((()=>[u("确定")])),_:1},8,["onClick"])]),n(Q,{key:"1",visible:g.dialogVisible,"onUpdate:visible":i[5]||(i[5]=e=>g.dialogVisible=e),title:"组织架构",defaultValues:g.form.manageUserInfo,onSuccess:b.getSelectUser},null,8,["visible","defaultValues","onSuccess"]),n(Q,{key:"2",visible:g.singleSelectVisible,"onUpdate:visible":i[6]||(i[6]=e=>g.singleSelectVisible=e),title:"组织架构",defaultValues:g.singleSelect,onSuccess:b.getSingleUser},null,8,["visible","defaultValues","onSuccess"])])}],["__scopeId","data-v-abb5c835"]]);export{q as default};
