import{g as e,u as i,a as t,d as s,b as l}from"../index-044285d2.js";import{C as a}from"./cos-js-sdk-v5-11e6b0ab.js";import{B as r}from"./benz-amr-recorder-259e7c16.js";import{M as o}from"./mp4box-a729e650.js";import{O as c}from"./ali-oss-912914b8.js";import{c as n,K as p,a9 as h,X as m,T as d,U as f,a as u,O as g,ai as y,o as j,_ as w,Z as v,a5 as $,Y as U,a3 as b,bl as k,bj as L}from"./@vue-e400fd81.js";import{_ as W}from"./quill-image-resize-module-c051113e.js";import"./js-cookie-8253c38e.js";/* empty css                      */import"./vue-router-f8d53be7.js";import"./element-plus-68ba2566.js";import"./lodash-es-d4f5f48c.js";import"./@element-plus-214e0f7b.js";import"./@popperjs-b78c3215.js";import"./@ctrl-91de2ec7.js";import"./dayjs-c17bc6b2.js";import"./@babel-efd68da6.js";import"./to-fast-properties-1160b370.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-36fbce82.js";import"./pinia-1b56b17e.js";import"./vue-demi-71ba0ef2.js";import"./jsencrypt-43f479c1.js";import"./crypto-js-d6a67473.js";import"./axios-fb5f9e0e.js";import"./@vueuse-4025ce01.js";import"./path-browserify-289407ee.js";import"./nprogress-a39edb90.js";import"./clipboard-7a0da8dc.js";import"./quill-c6b3d2fb.js";import"./quill-delta-a1872f89.js";import"./fast-diff-d5a53119.js";import"./lodash.clonedeep-1b6eefdc.js";import"./lodash.isequal-e7d08617.js";import"./@vueup-7cf8cfdd.js";const x={components:{},emits:["update:fileUrl","update:fileName","update:imgSize","update:width","update:heigth","update:pixelSize","update:fileList","upSuccess","getPicUrl","loadingChange"],props:{fileUrl:{type:String,default:""},fileName:{type:String,default:""},imgSize:{type:Number,default:void 0},fileList:{type:Array,default:()=>[]},type:{type:String,default:"0",validator:function(e){return["0","1","2","3"].includes(e)}},maxSize:{type:Number,default:void 0},maxImgPx:{type:Array,default:()=>[1024,1024]},format:{type:Array,default:void 0},accept:{type:String,default:""},multiple:{type:Boolean,default:!1},limit:{type:[Number,String],default:void 0}},data(){return{loading:!1,fileUrlWatch:this.fileUrl,fileNameWatch:this.fileName,fileListWatch:this.fileList,picUrl:"",file:void 0,speed:0,percentage:0,cosConfig:{bucketName:"",cosImgUrlPrefix:"",region:""},cosInstance:void 0,ossObj:void 0}},watch:{fileUrl:{handler(e){this.fileUrlWatch=e}},fileName:{handler(e){this.fileNameWatch=e}},fileList:{handler(e){this.fileListWatch=e},deep:!0},loading(e){this.$emit("loadingChange",e)}},computed:{acceptAuto(){return["image/*","amr/*","video/*"][this.type]}},created(){e().then((e=>{this.cosConfig=e,"tencentOss"==e.fileObject?this.cosInstance=new a({SecretId:e.secretId,SecretKey:e.secretKey}):"local"==e.fileObject||"minio"==e.fileObject||(this.ossObj=new c({region:e.region.split(".")[0],accessKeyId:e.secretId,accessKeySecret:e.secretKey,bucket:e.bucketName}))}))},mounted(){},methods:{upload(){"tencentOss"==this.cosConfig.fileObject?this.tencentFn():"local"==this.cosConfig.fileObject||"minio"==this.cosConfig.fileObject?this.localFn():"aliOss"==this.cosConfig.fileObject&&this.aliOss()},localFn(){let e;this.loading=!0,e=this.multiple&&1!=this.limit?this.file.shift():this.file;let s=new FormData;s.append("file",e),i(s).then((i=>{if(200==i.code){let s=i.data.url;this.$emit("upSuccess",s),2==this.type?t({url:s}).then((e=>{this.loading=!1,this.$emit("getPicUrl",e.data.url,e.data)})):this.loading=!1;let l=window.URL.createObjectURL(e),a=e.name,r=e.size;this.multiple?(this.fileListWatch=this.fileListWatch.concat({name:a,url:l,memorySize:r}),this.$emit("update:fileList",this.fileList.concat({name:a,url:s,memorySize:r}))):(this.fileUrlWatch=l,this.$emit("update:fileUrl",s),this.$emit("update:fileName",this.fileNameWatch=a),this.$emit("update:imgSize",r))}else this.loading=!1,this.$message.error("上传失败，请稍后再试")}))},async aliOss(){let e;this.loading=!0,e=this.multiple&&1!=this.limit?this.file.shift():this.file;let i=new Date,a=e.name.match(/\.(\w+)$/g);if(a=a&&a[0],!this.ossObj)return void this.$message.error("存储空间正忙，请稍后再试");let r=`${s(i,"YYYY-MM-DD")}/t${i.getTime()}-${l()}${a}`;try{const i=await this.ossObj.multipartUpload(r,e,{progress:e=>{e>0&&(this.percentage=100*e.toFixed(2))}});if(i){this.percentage=this.speed=0;let s=this.cosConfig.cosImgUrlPrefix+i.name;this.$emit("upSuccess",s),2==this.type?t({url:s}).then((e=>{this.loading=!1,this.$emit("getPicUrl",e.data.url,e.data)})):this.loading=!1;let l=window.URL.createObjectURL(e),a=e.name,r=e.size;this.multiple?(this.fileListWatch=this.fileListWatch.concat({name:a,url:l,memorySize:r}),this.$emit("update:fileList",this.fileList.concat({name:a,url:s,memorySize:r}))):(this.fileUrlWatch=l,this.$emit("update:fileUrl",s),this.$emit("update:fileName",this.fileNameWatch=a),this.$emit("update:imgSize",r))}}catch(o){this.loading=!1,this.$message.error("上传失败，请稍后再试")}},tencentFn(){let e;this.loading=!0,e=this.multiple&&1!=this.limit?this.file.shift():this.file;let i=new Date,a=e.name.match(/\.(\w+)$/g);a=a&&a[0];const r={Bucket:this.cosConfig.bucketName,Region:this.cosConfig.region,Key:`/${s(i,"YYYY-MM-DD")}/t${i.getTime()}-${l()}${a}`};this.cosInstance?this.cosInstance.uploadFile({...r,Body:e,onProgress:e=>{e.percent>0&&(this.percentage=100*e.percent.toFixed(2)),e.speed>0&&(this.speed=(e.speed/1024/1024).toFixed(2))}},((i,s)=>{if(this.percentage=this.speed=0,i)this.loading=!1,this.$message.error("上传失败，请稍后再试");else{let i="https://"+s.Location;this.$emit("upSuccess",i),2==this.type?t({url:i}).then((e=>{this.loading=!1,this.$emit("getPicUrl",e.data.url,e.data)})):this.loading=!1;let l=window.URL.createObjectURL(e),a=e.name,r=e.size;this.multiple?(this.fileListWatch=this.fileListWatch.concat({name:a,url:l,memorySize:r}),this.$emit("update:fileList",this.fileList.concat({name:a,url:i,memorySize:r}))):(this.fileUrlWatch=l,this.$emit("update:fileUrl",i),this.$emit("update:fileName",this.fileNameWatch=a),this.$emit("update:imgSize",r))}})):this.$message.error("存储空间正忙，请稍后再试")},remove(e){this.$confirm("确定要删除吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{let i=JSON.parse(JSON.stringify(this.fileList));this.fileListWatch.splice(e,1),i.splice(e,1),this.$emit("update:fileList",i)}))},handleExceed(e,i){this.$message.error("最多上传"+this.limit+"张"),this.loading=!1},async handleBeforeUpload(e,i){this.loading=!0;let t=!0,s=!0,l=this.format,a="";if(!l||!l.length){let e={0:{tip:"png/jpg",value:["png","jpg","jpeg"]},1:{value:["amr"]},2:{value:["mp4"]},3:{tip:"word/pdf/ppt",value:["doc","docx","pdf","ppt","pptx","pps","pptsx"]}};l=e[this.type].value,a=e[this.type].tip}const o=new RegExp(`\\.(${l.join("|")})$`,"ig");if(t="*"===l[0]||o.test(e.name),!t)return this.$message.error("文件格式错误，仅支持 "+(a||l.join("，"))+" 格式!"),this.loading=!1,Promise.reject();let c=this.maxSize;if(!c){c||(c={0:2,1:2,2:100,3:50}[this.type])}if(s=e.size/1024/1024<c,!s)return this.$message.error("上传文件大小不能超过 "+c+"MB!"),this.loading=!1,Promise.reject();let n=!0;if("0"===this.type){let i=this.maxImgPx;if(i)try{await new Promise((t=>{let s,l,a=new Image;if(a.onload=()=>{s=a.width,l=a.height,s>i[0]?(n=!1,this.$message.error(`图片“宽”度超过${i[0]}像素，请重新选择`)):l>i[1]&&(this.$message.error(`图片“高”度超过${i[1]}像素，请重新选择`),n=!1),window.URL&&window.URL.revokeObjectURL(a.src),t()},window.URL){let i=window.URL.createObjectURL(e);a.src=i}else if(window.FileReader){let i=new FileReader;i.onload=function(e){let i=e.target.result;a.src=i},i.readAsDataURL(e)}}))}catch(p){}}else if("1"===this.type){let i=new r;try{await i.initWithBlob(e),n=i.getDuration()<=60,n||this.$message.error("上传文件时长不能超过 60秒!")}catch(h){this.$message.error("文件已损坏")}}else if("2"===this.type){if(-1===(await this.checkVideoCode(e)).mime.indexOf("video/mp4"))return this.$message.error("mp4 格式不正确, 请使用标准编码视频!"),this.loading=!1,Promise.reject()}else this.type;return n?this.multiple&&1!=this.limit?(Array.isArray(this.file)||(this.file=[]),this.file.push(e)):this.file=e:this.loading=!1,n||Promise.reject()},onError(e,i,t){this.loading=!1,this.$message.error("上传文件失败")},checkVideoCode:e=>new Promise(((i,t)=>{const s=o.createFile(),l=new FileReader;l.readAsArrayBuffer(e),l.onload=function(e){const i=e.target.result;i.fileStart=0,s.appendBuffer(i)},s.onReady=function(e){i(e)},s.onError=function(e){t(e)}})),showView(e){(void 0!==e?this.$refs.image[e]:this.$refs.image).$el.firstElementChild.click()}}},S={class:"action-mask"},z={key:0,class:"uploader-icon upload-action uploader-size"},O={class:"upload-action uploader-size",key:1},C=(e=>(k("data-v-73057483"),e=e(),L(),e))((()=>u("div",{class:"el-loading-spinner"},[u("svg",{viewBox:"25 25 50 50",class:"circular"},[u("circle",{cx:"50",cy:"50",r:"20",fill:"none",class:"path"})])],-1))),N={key:1,class:"cc",style:{"margin-top":"35px"}},P={class:"upload-item",key:2},R=["src"],I=["href"],B={class:"tip"};const F=W(x,[["render",function(e,i,t,s,l,a){const r=y("el-image"),o=y("el-icon-search"),c=y("el-icon-delete"),k=y("el-icon-plus"),L=y("el-progress"),W=y("el-icon-EditPen"),x=y("el-icon-view"),F=y("el-upload");return j(),n("div",null,[t.multiple?(j(),n(p,{key:0},[0==t.type?(j(!0),n(p,{key:0},h(l.fileListWatch,((e,i)=>(j(),n("div",{key:i,class:"img-item upload-item"},[w(r,{ref_for:!0,ref:"image",class:"upload-img uploader-size",src:e.url,fit:"contain","preview-src-list":l.fileListWatch.map((e=>e.url)),alt:""},null,8,["src","preview-src-list"]),u("div",S,[w(o,{class:"el-icon-search mr5",onClick:e=>a.showView(i)},null,8,["onClick"]),w(c,{class:"el-icon-delete mr5",onClick:e=>a.remove(i)},null,8,["onClick"])])])))),128)):m("",!0)],64)):m("",!0),!t.multiple||!t.limit||l.fileListWatch.length<t.limit?(j(),d(F,{key:1,class:"uploader",action:"/api",accept:t.accept||a.acceptAuto,"http-request":a.upload,data:{mediaType:t.type},"show-file-list":!1,"file-list":l.fileListWatch,disabled:l.loading,multiple:t.multiple&&1!=t.limit,limit:t.limit,"on-error":a.onError,"on-exceed":a.handleExceed,"before-upload":a.handleBeforeUpload},{default:f((()=>[g(e.$slots,"default",{},(()=>[l.loading||l.fileUrlWatch?m("",!0):(j(),n("div",z,[w(k,{class:"el-icon-plus"})])),w(b,null,{default:f((()=>[l.loading?(j(),n("div",O,[l.percentage?(j(),d(L,{key:0,class:"progress cc",type:"circle",percentage:l.percentage},null,8,["percentage"])):m("",!0),C,l.speed?(j(),n("div",N,v(l.speed+"M/s"),1)):m("",!0)])):m("",!0),l.loading||!l.fileUrlWatch||t.multiple?m("",!0):(j(),n("div",P,["0"===t.type?(j(),n(p,{key:0},[l.fileUrlWatch?(j(),d(r,{key:0,ref:"image",src:l.fileUrlWatch,class:"upload-img upload-img-single uploader-size","preview-src-list":[l.fileUrlWatch],"preview-teleported":"",fit:"contain",onClick:i[0]||(i[0]=$((()=>{}),["stop"]))},null,8,["src","preview-src-list"])):m("",!0),u("div",{class:"action-mask",onClick:i[2]||(i[2]=$((()=>{}),["self","stop"]))},[w(o,{class:"el-icon-search",onClick:i[1]||(i[1]=$((e=>a.showView()),["stop"]))}),w(W,{class:"el-icon-EditPen"})])],64)):"2"===t.type?(j(),n(p,{key:1},[(j(),n("video",{ref:"video",id:"myVideo",class:"upload-video",width:"100%",controls:"","webkit-playsinline":"true",playsinline:"true",autoplay:!1,key:l.fileUrlWatch,preload:"auto"},[u("source",{src:l.fileUrlWatch,type:"video/mp4"},null,8,R)])),u("div",{class:"action-mask",style:{height:"30%"},onClick:i[3]||(i[3]=$((()=>{}),["self","stop"]))},[w(W,{class:"el-icon-EditPen"})])],64)):(j(),n(p,{key:2},[U(v(l.fileNameWatch||l.fileUrlWatch)+" ",1),w(W,{class:"el-icon-EditPen ml10"}),u("a",{onClick:i[4]||(i[4]=$((()=>{}),["stop"])),href:/\.mp4$/.test(l.fileNameWatch)?t.fileUrl:l.fileUrlWatch,target:"_blank"},[w(x,{class:"el-icon-view ml10",style:{"vertical-align":"middle"}})],8,I)],64))]))])),_:1})]),!0)])),_:3},8,["accept","http-request","data","file-list","disabled","multiple","limit","on-error","on-exceed","before-upload"])):m("",!0),u("div",B,[g(e.$slots,"tip",{},void 0,!0)])])}],["__scopeId","data-v-73057483"]]);export{F as default};
